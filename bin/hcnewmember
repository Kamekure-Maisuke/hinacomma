#!/bin/zsh

set -e

DATA_DIR="$(dirname $0)/../data"

error_and_usage(){
  cat <<EOF
Usage: ${0##*/}
EOF
  exit 1
}

# 引数が1以上ならエラー
[ "$#" -ge 1 ] && error_and_usage

# メンバーの最後の1文字抜き出し
final_name=$(
  cut -f1 "$DATA_DIR/member_info_all.tsv" | sed 's/^.*\(.$\)/\1/g' | tr -d '\n' | iconv -t UCS-2BE | od -tx1 -An | sed -e '/^$/d' -e 's/ //g' |
  fold -w4 | grep -Ev '^30' | while IFS='' read -r line;do printf "\u$line\n"; done
)
row=$(echo "$final_name" | grep '' -c)
final_row_random=$((RANDOM % row + 1))

# 最初の3文字出力
cut -f1 "$DATA_DIR/member_info_all.tsv" |
tr -d '\n' |
iconv -t UCS-2BE |
od -tx1 -An |
sed -e '/^$/d' -e 's/ //g' |
fold -w4 |
grep -Ev '^30' |
while IFS='' read -r line;do printf "\u$line\n"; done |
awk -v seed="$RANDOM" '
BEGIN{
  srand(seed)
}
{
  a[NR]=$1
}
END{
  for(i=1;i<=3;i++){
    printf a[int(rand()*NR+1)]
  }
}'

# 最後の文字出力
# 名前感を持たせるため
echo "$final_name" | awk -v row="$final_row_random" 'NR==row{print}'
